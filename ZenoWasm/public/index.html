<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>ZenoWasm SPA</title>
	<script src="wasm_exec.js"></script>
	<script src="https://cdn.tailwindcss.com"></script>
	<script>
		const go = new Go();
		WebAssembly.instantiateStreaming(fetch("zeno.wasm"), go.importObject).then((result) => {
			go.run(result.instance);
			console.log("Zeno Engine Loaded");

			// 1. Register Views
			zenoRegisterTemplate("layout", `
				<div class="min-h-screen bg-gray-50 flex flex-col font-sans text-gray-800"
				     data-signals="{isAuth: {{ $auth_check ? 'true' : 'false' }} }">
					<nav class="bg-indigo-600 text-white p-4 shadow-md">
						<div class="container mx-auto flex justify-between items-center">
							<a href="/" class="text-xl font-bold">ZenoWasm SPA</a>
							<div class="space-x-4 flex items-center">
								<a href="/" class="hover:underline">Home</a>
								<a href="/counter" class="hover:underline">Counter</a>
								<a href="/interop" class="hover:underline">JS Interop</a>
								<a href="/dashboard" class="hover:underline font-semibold text-yellow-300">Dashboard (Protected)</a>

								<button class="px-3 py-1 text-sm bg-white text-indigo-600 rounded"
								        onclick="toggleAuth()">
									{{ $auth_check ? 'Logout' : 'Login' }}
								</button>
							</div>
						</div>
					</nav>
					<main class="container mx-auto p-6 flex-grow">
						@yield('content')
					</main>
					<footer class="bg-gray-200 text-center p-4 text-sm text-gray-600">
						Powered by ZenoWasm & Datastar
					</footer>
				</div>
			`);

			zenoRegisterTemplate("home", `
				@extends('layout')
				@section('content')
					<div class="text-center py-10">
						<h1 class="text-4xl font-bold text-indigo-700 mb-4">Welcome to ZenoWasm</h1>
						<p class="text-lg text-gray-600 mb-8">
							A lightweight, serverless SPA framework running Go & Blade in your browser.
						</p>
						<div class="grid grid-cols-1 md:grid-cols-3 gap-6">
							<div class="p-6 bg-white rounded-lg shadow">
								<h3 class="font-bold text-xl mb-2">‚ö° Fast</h3>
								<p>Compiles to WebAssembly for near-native performance.</p>
							</div>
							<div class="p-6 bg-white rounded-lg shadow">
								<h3 class="font-bold text-xl mb-2">üõ°Ô∏è Secure</h3>
								<p>Supports Route Guards (Middleware) to protect pages.</p>
							</div>
							<div class="p-6 bg-white rounded-lg shadow">
								<h3 class="font-bold text-xl mb-2">üéà Lightweight</h3>
								<p>Zero dependencies. No Node.js. No complex build tools.</p>
							</div>
						</div>
					</div>
				@endsection
			`);

			zenoRegisterTemplate("counter", `
				@extends('layout')
				@section('content')
					<div class="max-w-md mx-auto bg-white p-8 rounded-lg shadow-md"
					     data-signals="{count: 0}">
						<h2 class="text-2xl font-bold mb-4">Reactive Counter</h2>
						<p class="mb-6 text-gray-600">This state is managed client-side by Datastar.</p>

						<div class="text-5xl font-mono text-center my-8 text-indigo-600" data-text="$count">
							0
						</div>

						<div class="flex gap-4 justify-center">
							<button class="px-6 py-2 bg-red-500 text-white rounded hover:bg-red-600 transition"
									data-on-click="$count--">
								- Decrease
							</button>
							<button class="px-6 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition"
									data-on-click="$count++">
								+ Increase
							</button>
						</div>
					</div>
				@endsection
			`);

			zenoRegisterTemplate("interop", `
				@extends('layout')
				@section('content')
					<div class="max-w-2xl mx-auto bg-white p-8 rounded-lg shadow-md">
						<h2 class="text-2xl font-bold mb-4">JS Interop Demo</h2>
						<p class="mb-4">Zeno can talk to JavaScript directly!</p>

						<div class="space-y-4">
							<div class="p-4 border rounded bg-gray-50">
								<h3 class="font-bold">1. Call JS Alert</h3>
								<p class="text-sm text-gray-500 mb-2">Code: <code>js.call: 'alert' { args: ['Hello!'] }</code></p>
								<button class="px-4 py-2 bg-purple-600 text-white rounded"
								        onclick="zenoNavigate('/run-alert')">
									Trigger Alert
								</button>
							</div>

							<div class="p-4 border rounded bg-gray-50">
								<h3 class="font-bold">2. Change Page Title</h3>
								<p class="text-sm text-gray-500 mb-2">Code: <code>js.set: 'document.title' { val: 'New Title' }</code></p>
								<button class="px-4 py-2 bg-green-600 text-white rounded"
								        onclick="zenoNavigate('/run-title')">
									Change Title
								</button>
							</div>

							<div class="p-4 border rounded bg-gray-50">
								<h3 class="font-bold">3. Read Window Size</h3>
								<p class="text-sm text-gray-500 mb-2">Code: <code>js.get: 'window.innerWidth' { as: $w }</code></p>
								<button class="px-4 py-2 bg-blue-600 text-white rounded"
								        onclick="zenoNavigate('/run-read-window')">
									Read Size
								</button>
								@if($window_width)
									<p class="mt-2 font-mono text-blue-600">Detected Width: {{ $window_width }}px</p>
								@endif
							</div>
						</div>
					</div>
				@endsection
			`);

			zenoRegisterTemplate("dashboard", `
				@extends('layout')
				@section('content')
					<div class="bg-green-100 border-l-4 border-green-500 text-green-700 p-4 mb-4" role="alert">
						<p class="font-bold">Access Granted</p>
						<p>You are viewing the protected Dashboard.</p>
					</div>
					<div class="bg-white p-6 rounded shadow">
						<h2 class="text-2xl font-bold mb-4">User Dashboard</h2>
						<p>This page is only accessible if you are logged in.</p>
					</div>
				@endsection
			`);

			zenoRegisterTemplate("login", `
				@extends('layout')
				@section('content')
					<div class="max-w-md mx-auto bg-white p-8 rounded-lg shadow-md text-center">
						<h2 class="text-2xl font-bold mb-4 text-red-600">Access Denied</h2>
						<p class="mb-6">You must login to view that page.</p>
						<button class="px-6 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 transition"
						        onclick="toggleAuth(); zenoNavigate('/dashboard')">
							Login & Go to Dashboard
						</button>
					</div>
				@endsection
			`);

			// 2. Initialize Router
			zenoInitRouter(`
				router.get: '/' { view: 'home' }
				router.get: '/counter' { view: 'counter' }
				router.get: '/interop' { view: 'interop' }
				router.get: '/login' { view: 'login' }

				# Interop Actions (return to view after action)
				router.get: '/run-alert' {
					do: {
						js.call: 'alert' { args: ['Hello from Zeno!'] }
						view: 'interop'
					}
				}

				router.get: '/run-title' {
					do: {
						js.set: 'document.title' { value: 'Zeno is Awesome!' }
						view: 'interop'
					}
				}

				router.get: '/run-read-window' {
					do: {
						js.get: 'window.innerWidth' { as: $window_width }
						view: 'interop'
					}
				}

				# Protected Routes
				router.group: {
					middleware: 'auth'
					do: {
						router.get: '/dashboard' { view: 'dashboard' }
					}
				}
			`);

		}).catch((err) => {
			console.error(err);
		});

		// Auth Helper
		let isAuth = false;
		function toggleAuth() {
			isAuth = !isAuth;
			zenoSetAuthState(isAuth);
			// Refresh current page to update layout
			zenoNavigate(window.location.pathname);
		}
	</script>
</head>
<body>
	<div id="app">Loading...</div>
</body>
</html>
