<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>ZenoWasm SPA</title>
	<script src="wasm_exec.js"></script>
	<script src="https://cdn.tailwindcss.com"></script>
	<script>
		const go = new Go();
		WebAssembly.instantiateStreaming(fetch("zeno.wasm"), go.importObject).then((result) => {
			go.run(result.instance);
			console.log("Zeno Engine Loaded");

			// 1. Register Views
			zenoRegisterTemplate("layout", `
				<div class="min-h-screen bg-gray-50 flex flex-col font-sans text-gray-800"
				     data-signals="{isAuth: {{ $auth_check ? 'true' : 'false' }} }">
					<nav class="bg-indigo-600 text-white p-4 shadow-md">
						<div class="container mx-auto flex justify-between items-center">
							<a href="/" class="text-xl font-bold">ZenoWasm SPA</a>
							<div class="space-x-4 flex items-center">
								<a href="/" class="hover:underline">Home</a>
								<a href="/finance" class="hover:underline">Finance</a>
								<a href="/fetch" class="hover:underline">Fetch</a>
								<a href="/dashboard" class="hover:underline font-semibold text-yellow-300">Dashboard</a>

								<button class="px-3 py-1 text-sm bg-white text-indigo-600 rounded"
								        onclick="toggleAuth()">
									{{ $auth_check ? 'Logout' : 'Login' }}
								</button>
							</div>
						</div>
					</nav>
					<main class="container mx-auto p-6 flex-grow">
						@yield('content')
					</main>
					<footer class="bg-gray-200 text-center p-4 text-sm text-gray-600">
						Powered by ZenoWasm & Datastar
					</footer>
				</div>
			`);

			zenoRegisterTemplate("home", `
				@extends('layout')
				@section('content')
					<div class="text-center py-10">
						<h1 class="text-4xl font-bold text-indigo-700 mb-4">Welcome to ZenoWasm</h1>
						<p class="text-lg text-gray-600 mb-8">
							A lightweight, serverless SPA framework running Go & Blade in your browser.
						</p>
						<div class="grid grid-cols-1 md:grid-cols-4 gap-6">
							<div class="p-6 bg-white rounded-lg shadow">
								<h3 class="font-bold text-xl mb-2">‚ö° Fast</h3>
								<p>Compiles to WebAssembly for near-native performance.</p>
							</div>
							<div class="p-6 bg-white rounded-lg shadow">
								<h3 class="font-bold text-xl mb-2">üí∞ Precise</h3>
								<p>Financial calculations using Decimal types.</p>
							</div>
							<div class="p-6 bg-white rounded-lg shadow">
								<h3 class="font-bold text-xl mb-2">üíæ Persistent</h3>
								<p>Supports LocalStorage and Session Persistence.</p>
							</div>
							<div class="p-6 bg-white rounded-lg shadow">
								<h3 class="font-bold text-xl mb-2">üåê Native Fetch</h3>
								<p>Async HTTP client built-in for data fetching.</p>
							</div>
						</div>
					</div>
				@endsection
			`);

			zenoRegisterTemplate("finance", `
				@extends('layout')
				@section('content')
					<div class="max-w-2xl mx-auto bg-white p-8 rounded-lg shadow-md"
					     data-signals="{price: 150000, qty: 1, taxRate: 0.11}">

						<h2 class="text-2xl font-bold mb-6 text-gray-800">Financial Calculator</h2>

						<div class="grid grid-cols-2 gap-4 mb-6">
							<div>
								<label class="block text-sm font-bold mb-1">Price (IDR)</label>
								<input type="number" data-bind-price class="w-full border p-2 rounded">
							</div>
							<div>
								<label class="block text-sm font-bold mb-1">Quantity</label>
								<input type="number" data-bind-qty class="w-full border p-2 rounded">
							</div>
						</div>

						<div class="p-4 bg-gray-100 rounded border border-gray-300">
							<div class="flex justify-between mb-2">
								<span>Subtotal:</span>
								<span data-text="$subtotal">0</span>
							</div>
							<div class="flex justify-between mb-2">
								<span>Tax (11%):</span>
								<span data-text="$tax">0</span>
							</div>
							<div class="flex justify-between font-bold text-lg pt-2 border-t border-gray-300">
								<span>Total:</span>
								<span data-text="$total">0</span>
							</div>
						</div>

						<button class="mt-4 w-full bg-green-600 text-white py-2 rounded hover:bg-green-700"
						        onclick="calculateTotal()">
							Calculate (Precise Decimal)
						</button>
					</div>
				@endsection
			`);

			zenoRegisterTemplate("calc_action", `
				do: {
					money.calc: $price * $qty { as: $sub }
					money.calc: $sub * 0.11 { as: $tax_val }
					money.calc: $sub + $tax_val { as: $tot }

					money.format: $sub { as: $f_sub }
					money.format: $tax_val { as: $f_tax }
					money.format: $tot { as: $f_tot }

					js.call: 'updateFinanceUI' { args: [$f_sub, $f_tax, $f_tot] }
				}
			`);

			zenoRegisterTemplate("fetch", `
				@extends('layout')
				@section('content')
					<div class="max-w-2xl mx-auto bg-white p-8 rounded-lg shadow-md"
					     data-signals="{todoTitle: 'Loading...', todoCompleted: false}">

						<h2 class="text-2xl font-bold mb-4">Native Fetch API</h2>
						<div class="p-6 border rounded bg-gray-50 flex items-center justify-between">
							<div>
								<h4 class="font-bold text-lg" data-text="$todoTitle">Loading...</h4>
								<span class="text-sm px-2 py-1 rounded"
								      data-class="{'bg-green-200 text-green-800': $todoCompleted, 'bg-yellow-200 text-yellow-800': !$todoCompleted}"
								      data-text="$todoCompleted ? 'Completed' : 'Pending'">
									Status
								</span>
							</div>
							<button class="px-4 py-2 bg-indigo-600 text-white rounded"
							        onclick="zenoNavigate('/do-fetch')">
								Reload Data
							</button>
						</div>
					</div>
				@endsection
			`);

			zenoRegisterTemplate("dashboard", `
				@extends('layout')
				@section('content')
					<div class="bg-green-100 border-l-4 border-green-500 text-green-700 p-4 mb-4" role="alert">
						<p class="font-bold">Access Granted</p>
						<p>You are viewing the protected Dashboard.</p>
					</div>

					<div class="bg-white p-6 rounded shadow mb-6">
						<h2 class="text-2xl font-bold mb-4">User Profile</h2>
						<p><strong>Username:</strong> {{ $user.username }}</p>
						<p><strong>Role:</strong> {{ $user.role }}</p>
					</div>

					<button class="px-4 py-2 bg-red-600 text-white rounded"
					        onclick="zenoNavigate('/action-logout')">
						Logout
					</button>
				@endsection
			`);

			zenoRegisterTemplate("login", `
				@extends('layout')
				@section('content')
					<div class="max-w-md mx-auto bg-white p-8 rounded-lg shadow-md text-center">
						<h2 class="text-2xl font-bold mb-4 text-gray-800">Login Required</h2>
						<p class="mb-6 text-gray-600">Please login to access the dashboard.</p>
						<button class="px-6 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 transition"
						        onclick="zenoNavigate('/action-login')">
							Login as Admin
						</button>
					</div>
				@endsection
			`);

			// 2. Initialize Router
			zenoInitRouter(`
				router.get: '/' { view: 'home' }
				router.get: '/finance' { view: 'finance' }
				router.get: '/fetch' {
					do: {
						http.fetch: 'https://jsonplaceholder.typicode.com/todos/1' {
							then: {
								as: $todo
								view: 'fetch'
								js.call: 'window.updateSignals' { args: [$todo] }
							}
						}
						view: 'fetch'
					}
				}
				router.get: '/login' { view: 'login' }

				# Auth Actions
				router.get: '/action-login' {
					do: {
						# Simulate API login
						var: $user
						scope.set: {
							as: $user
							val: { username: 'admin', role: 'superuser' }
						}

						auth.login: {
							token: 'mock-jwt-token-123'
							user: $user
						}

						# Redirect to dashboard
						js.call: 'zenoNavigate' { args: ['/dashboard'] }
					}
				}

				router.get: '/action-logout' {
					do: {
						auth.logout
						js.call: 'zenoNavigate' { args: ['/'] }
					}
				}

				router.get: '/do-fetch' {
					do: {
						http.fetch: 'https://jsonplaceholder.typicode.com/todos/2' {
							then: {
								as: $todo
								js.call: 'window.updateSignals' { args: [$todo] }
							}
						}
					}
				}

				# Protected Routes
				router.group: {
					middleware: 'auth'
					do: {
						router.get: '/dashboard' {
							do: {
								auth.user: { as: $user }
								view: 'dashboard'
							}
						}
					}
				}
			`);

		}).catch((err) => {
			console.error(err);
		});

		// Helper to toggle auth via simple button in navbar (for quick testing)
		// But real logic is now in /action-login
		function toggleAuth() {
			// Check if logged in via storage
			const token = localStorage.getItem("zeno_auth_token");
			if (token) {
				zenoNavigate('/action-logout');
			} else {
				zenoNavigate('/action-login');
			}
		}

		window.updateSignals = function(todo) {
			const titleEl = document.querySelector('[data-text="$todoTitle"]');
			if(titleEl) titleEl.textContent = todo.title;
		}

		window.calculateTotal = function() {
			const price = document.querySelector('[data-bind-price]').value;
			const qty = document.querySelector('[data-bind-qty]').value;
			const data = JSON.stringify({ price: price, qty: qty });
			zenoRender("calc_action", data);
		}

		window.updateFinanceUI = function(sub, tax, tot) {
			document.querySelector('[data-text="$subtotal"]').textContent = sub;
			document.querySelector('[data-text="$tax"]').textContent = tax;
			document.querySelector('[data-text="$total"]').textContent = tot;
		}
	</script>
</head>
<body>
	<div id="app">Loading...</div>
</body>
</html>
