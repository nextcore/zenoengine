<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>ZenoWasm SPA</title>
	<script src="wasm_exec.js"></script>
	<script src="https://cdn.tailwindcss.com"></script>
	<script>
		const go = new Go();
		WebAssembly.instantiateStreaming(fetch("zeno.wasm"), go.importObject).then((result) => {
			go.run(result.instance);
			console.log("Zeno Engine Loaded");

			// 1. Register Views
			zenoRegisterTemplate("layout", `
				<div class="min-h-screen bg-gray-50 flex flex-col font-sans text-gray-800"
				     data-signals="{isAuth: {{ $auth_check ? 'true' : 'false' }} }">
					<nav class="bg-indigo-600 text-white p-4 shadow-md">
						<div class="container mx-auto flex justify-between items-center">
							<a href="/" class="text-xl font-bold">ZenoWasm SPA</a>
							<div class="space-x-4 flex items-center">
								<a href="/" class="hover:underline">Home</a>
								<a href="/finance" class="hover:underline">Finance</a>
								<a href="/fetch" class="hover:underline">Fetch</a>
								<a href="/interop" class="hover:underline">Interop</a>

								<button class="px-3 py-1 text-sm bg-white text-indigo-600 rounded"
								        onclick="toggleAuth()">
									{{ $auth_check ? 'Logout' : 'Login' }}
								</button>
							</div>
						</div>
					</nav>
					<main class="container mx-auto p-6 flex-grow">
						@yield('content')
					</main>
					<footer class="bg-gray-200 text-center p-4 text-sm text-gray-600">
						Powered by ZenoWasm & Datastar
					</footer>
				</div>
			`);

			zenoRegisterTemplate("home", `
				@extends('layout')
				@section('content')
					<div class="text-center py-10">
						<h1 class="text-4xl font-bold text-indigo-700 mb-4">Welcome to ZenoWasm</h1>
						<p class="text-lg text-gray-600 mb-8">
							A lightweight, serverless SPA framework running Go & Blade in your browser.
						</p>
						<div class="grid grid-cols-1 md:grid-cols-4 gap-6">
							<div class="p-6 bg-white rounded-lg shadow">
								<h3 class="font-bold text-xl mb-2">‚ö° Fast</h3>
								<p>Compiles to WebAssembly for near-native performance.</p>
							</div>
							<div class="p-6 bg-white rounded-lg shadow">
								<h3 class="font-bold text-xl mb-2">üí∞ Precise</h3>
								<p>Financial calculations using Decimal types.</p>
							</div>
							<div class="p-6 bg-white rounded-lg shadow">
								<h3 class="font-bold text-xl mb-2">üõ°Ô∏è Secure</h3>
								<p>Supports Route Guards (Middleware) to protect pages.</p>
							</div>
							<div class="p-6 bg-white rounded-lg shadow">
								<h3 class="font-bold text-xl mb-2">üéà Lightweight</h3>
								<p>Zero dependencies. No Node.js.</p>
							</div>
						</div>
					</div>
				@endsection
			`);

			zenoRegisterTemplate("finance", `
				@extends('layout')
				@section('content')
					<div class="max-w-2xl mx-auto bg-white p-8 rounded-lg shadow-md"
					     data-signals="{price: 150000, qty: 1, taxRate: 0.11}">

						<h2 class="text-2xl font-bold mb-6 text-gray-800">Financial Calculator</h2>

						<div class="grid grid-cols-2 gap-4 mb-6">
							<div>
								<label class="block text-sm font-bold mb-1">Price (IDR)</label>
								<input type="number" data-bind-price class="w-full border p-2 rounded">
							</div>
							<div>
								<label class="block text-sm font-bold mb-1">Quantity</label>
								<input type="number" data-bind-qty class="w-full border p-2 rounded">
							</div>
						</div>

						<div class="p-4 bg-gray-100 rounded border border-gray-300">
							<div class="flex justify-between mb-2">
								<span>Subtotal:</span>
								<!-- Logic calculated by Zeno on Render or via signals if we implemented signal expressions.
								     For now, let's use a button to trigger precise calculation via Zeno logic. -->
								<span data-text="$subtotal">0</span>
							</div>
							<div class="flex justify-between mb-2">
								<span>Tax (11%):</span>
								<span data-text="$tax">0</span>
							</div>
							<div class="flex justify-between font-bold text-lg pt-2 border-t border-gray-300">
								<span>Total:</span>
								<span data-text="$total">0</span>
							</div>
						</div>

						<button class="mt-4 w-full bg-green-600 text-white py-2 rounded hover:bg-green-700"
						        onclick="calculateTotal()">
							Calculate (Precise Decimal)
						</button>
					</div>
				@endsection
			`);

			// Register Calculation Logic
			zenoRegisterTemplate("calc_action", `
				do: {
					# Recieve inputs from params
					# Use money.calc for precision

					money.calc: $price * $qty { as: $sub }
					money.calc: $sub * 0.11 { as: $tax_val }
					money.calc: $sub + $tax_val { as: $tot }

					# Format output
					money.format: $sub { as: $f_sub }
					money.format: $tax_val { as: $f_tax }
					money.format: $tot { as: $f_tot }

					# Update UI via JS
					js.call: 'updateFinanceUI' { args: [$f_sub, $f_tax, $f_tot] }
				}
			`);

			zenoRegisterTemplate("fetch", `
				@extends('layout')
				@section('content')
					<div class="max-w-2xl mx-auto bg-white p-8 rounded-lg shadow-md"
					     data-signals="{todoTitle: 'Loading...', todoCompleted: false}">

						<h2 class="text-2xl font-bold mb-4">Native Fetch API</h2>
						<div class="p-6 border rounded bg-gray-50 flex items-center justify-between">
							<div>
								<h4 class="font-bold text-lg" data-text="$todoTitle">Loading...</h4>
								<span class="text-sm px-2 py-1 rounded"
								      data-class="{'bg-green-200 text-green-800': $todoCompleted, 'bg-yellow-200 text-yellow-800': !$todoCompleted}"
								      data-text="$todoCompleted ? 'Completed' : 'Pending'">
									Status
								</span>
							</div>
							<button class="px-4 py-2 bg-indigo-600 text-white rounded"
							        onclick="zenoNavigate('/do-fetch')">
								Reload Data
							</button>
						</div>
					</div>
				@endsection
			`);

			zenoRegisterTemplate("interop", `
				@extends('layout')
				@section('content')
					<div class="max-w-2xl mx-auto bg-white p-8 rounded-lg shadow-md">
						<h2 class="text-2xl font-bold mb-4">JS Interop Demo</h2>
						<div class="space-y-4">
							<div class="p-4 border rounded bg-gray-50">
								<h3 class="font-bold">1. Call JS Alert</h3>
								<button class="px-4 py-2 bg-purple-600 text-white rounded"
								        onclick="zenoNavigate('/run-alert')">
									Trigger Alert
								</button>
							</div>
						</div>
					</div>
				@endsection
			`);

			zenoRegisterTemplate("login", `
				@extends('layout')
				@section('content')
					<div class="max-w-md mx-auto bg-white p-8 rounded-lg shadow-md text-center">
						<h2 class="text-2xl font-bold mb-4 text-red-600">Access Denied</h2>
						<p class="mb-6">You must login to view that page.</p>
						<button class="px-6 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 transition"
						        onclick="toggleAuth(); zenoNavigate('/dashboard')">
							Login & Go to Dashboard
						</button>
					</div>
				@endsection
			`);

			// 2. Initialize Router
			zenoInitRouter(`
				router.get: '/' { view: 'home' }
				router.get: '/finance' { view: 'finance' }
				router.get: '/fetch' {
					do: {
						http.fetch: 'https://jsonplaceholder.typicode.com/todos/1' {
							then: {
								as: $todo
								view: 'fetch'
								js.call: 'window.updateSignals' { args: [$todo] }
							}
						}
						view: 'fetch'
					}
				}
				router.get: '/interop' { view: 'interop' }
				router.get: '/login' { view: 'login' }

				# Actions
				router.get: '/do-fetch' {
					do: {
						http.fetch: 'https://jsonplaceholder.typicode.com/todos/2' {
							then: {
								as: $todo
								js.call: 'window.updateSignals' { args: [$todo] }
							}
						}
					}
				}

				router.get: '/run-alert' {
					do: {
						js.call: 'alert' { args: ['Hello from Zeno!'] }
						view: 'interop'
					}
				}

				# Protected Routes
				router.group: {
					middleware: 'auth'
					do: {
						router.get: '/dashboard' { view: 'home' } # Redirect to home as placeholder
					}
				}
			`);

		}).catch((err) => {
			console.error(err);
		});

		// Auth Helper
		let isAuth = false;
		function toggleAuth() {
			isAuth = !isAuth;
			zenoSetAuthState(isAuth);
			zenoNavigate(window.location.pathname);
		}

		window.updateSignals = function(todo) {
			const titleEl = document.querySelector('[data-text="$todoTitle"]');
			if(titleEl) titleEl.textContent = todo.title;
		}

		// Finance Helper
		window.calculateTotal = function() {
			// Read signals manually for this demo (or use Datastar store if available)
			const price = document.querySelector('[data-bind-price]').value;
			const qty = document.querySelector('[data-bind-qty]').value;

			// Call Zeno Logic
			const data = JSON.stringify({ price: price, qty: qty });
			zenoRender("calc_action", data);
		}

		window.updateFinanceUI = function(sub, tax, tot) {
			document.querySelector('[data-text="$subtotal"]').textContent = sub;
			document.querySelector('[data-text="$tax"]').textContent = tax;
			document.querySelector('[data-text="$total"]').textContent = tot;
		}
	</script>
</head>
<body>
	<div id="app">Loading...</div>
</body>
</html>
