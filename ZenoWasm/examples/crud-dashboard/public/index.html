<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Zeno CRUD Dashboard</title>
	<script src="wasm_exec.js"></script>
	<script src="https://cdn.tailwindcss.com"></script>
	<script>
		const go = new Go();

		// List of files to fetch
		const files = [
			'routes.zl',
			'views/layout.blade.zl',
			'views/login.blade.zl',
			'views/products/index.blade.zl',
			'views/products/form.blade.zl'
		];

		async function init() {
			// 1. Load WASM
			const wasmResult = await WebAssembly.instantiateStreaming(fetch("zeno.wasm"), go.importObject);
			go.run(wasmResult.instance);
			console.log("Zeno Engine Loaded");

			// 2. Fetch and Register All Files
			await Promise.all(files.map(async (path) => {
				const resp = await fetch(path);
				if (!resp.ok) {
					console.error("Failed to load:", path);
					return;
				}
				const content = await resp.text();
				zenoRegisterTemplate(path, content); // Register file with its path as name
				console.log("Registered:", path);
			}));

			// 3. Initialize Router (using content of routes.zl)
			// Since we registered it, we can fetch it back?
			// Or we just fetch routes.zl again separately?
			// Or we ask Zeno to execute a registered script?
			// zenoInitRouter currently expects CONTENT string.
			// Let's refetch content of routes.zl or store it temporarily in JS.

			// Simple approach: Fetch routes.zl content again or grab from memory if we saved it.
			// Let's fetch routes.zl content explicitly for initRouter.
			const routesResp = await fetch('routes.zl');
			const routesContent = await routesResp.text();

			zenoInitRouter(routesContent);
		}

		init().catch(console.error);

		// --- JS Adapters for Signals & Actions ---

		function doLogin() {
			zenoNavigate('/do-login-action');
		}

		function saveProduct() {
			zenoNavigate('/do-save-product');
		}

		function deleteProduct(id) {
			zenoNavigate('/do-delete/' + id);
		}

		window.getSignal = function(key) {
			const el = document.querySelector('[data-bind-' + key + ']');
			return el ? el.value : '';
		}

	</script>
</head>
<body class="bg-gray-100">
	<div id="app">Loading Application...</div>
</body>
</html>
